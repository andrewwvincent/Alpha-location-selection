<!DOCTYPE html>
<html>
<head>
    <title>US School Location Analysis - National Interactive Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="us_schools_data.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .info-panel h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .control-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .state-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        
        .state-checkbox {
            display: flex;
            align-items: center;
            font-size: 12px;
        }
        
        .state-checkbox input {
            margin-right: 5px;
        }
        
        .tract-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 14px;
        }
        
        .school-contribution {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        
        .dual-range-slider {
            position: relative;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            margin: 10px 0;
        }
        
        .dual-range-slider input[type="range"] {
            position: absolute;
            width: 100%;
            height: 6px;
            background: transparent;
            pointer-events: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .dual-range-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            pointer-events: all;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .dual-range-slider input[type="range"]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            pointer-events: all;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .range-track {
            position: absolute;
            height: 6px;
            background: #007bff;
            border-radius: 3px;
            top: 0;
        }
        
        .school-name {
            font-weight: bold;
            color: #333;
        }
        
        .contribution-details {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .control-button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background-color 0.2s;
        }
        
        .recalculate-btn {
            background: #007bff;
            color: white;
        }
        
        .recalculate-btn:hover {
            background: #0056b3;
        }
        
        .reset-btn {
            background: #6c757d;
            color: white;
            font-size: 12px;
            padding: 8px;
        }
        
        .reset-btn:hover {
            background: #545b62;
        }
        
        .total-score {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
        }
        
        .stats {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading US school analysis data...</div>
    
    <!-- Confirmation dialog for large recalculations -->
    <div id="confirmation-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">Large Recalculation</h3>
            <p id="confirmation-message" style="margin: 0 0 15px 0; color: #666; line-height: 1.4;"></p>
            <div style="text-align: right;">
                <button onclick="cancelRecalculation()" style="margin-right: 10px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button onclick="proceedWithRecalculation()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Recalculate</button>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="info-panel">
        <h3>US School Analysis</h3>
        
        <div class="control-group">
            <label for="tuition-slider">Proposed Tuition: <span id="tuition-value">$40,000</span></label>
            <input type="range" id="tuition-slider" min="20000" max="75000" value="40000" step="5000" oninput="updateTuitionValue();">
        </div>
        
        <div class="control-group">
            <label for="market-type">Market Analysis Type:</label>
            <select id="market-type">
                <option value="conservative">Conservative (2.5x income, 12x home)</option>
                <option value="moderate" selected>Moderate (3x income, 15x home)</option>
                <option value="aggressive">Aggressive (3.5x income, 18x home)</option>
                <option value="premium">Premium Coastal (4x income, 21x home)</option>
                <option value="custom">Custom Multipliers...</option>
            </select>
        </div>
        
        <div id="custom-multipliers" style="display: none;">
            <div class="control-group">
                <label for="income-multiplier">Income Multiplier: <span id="income-multiplier-value">3.0</span>x</label>
                <input type="range" id="income-multiplier" min="1.5" max="6" value="3.0" step="0.5">
            </div>
            <div class="control-group">
                <label for="home-multiplier">Home Value Multiplier: <span id="home-multiplier-value">15.0</span>x</label>
                <input type="range" id="home-multiplier" min="8" max="25" value="15" step="1">
            </div>
        </div>
        
        <div class="control-group">
            <label for="tuition-scaling-slider">Tuition Scaling Factor: <span id="tuition-scaling-value">25%</span></label>
            <input type="range" id="tuition-scaling-slider" min="10" max="50" step="5" value="25" oninput="updateTuitionScalingValue();">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <span>10%</span>
            </div>
        </div>
        
        <div class="control-group">
            <label for="distance-range">Distance Range: <span id="distance-range-value">5-20 miles</span></label>
            <div class="dual-range-slider">
                <div class="range-track" id="range-track"></div>
                <input type="range" id="distance-min-slider" min="1" max="25" step="1" value="5" 
                       oninput="updateDistanceRange();">
                <input type="range" id="distance-max-slider" min="5" max="30" step="1" value="20" 
                       oninput="updateDistanceRange();">
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <span>1 mile</span>
                <span>30 miles</span>
            </div>
            <div style="font-size: 11px; color: #888; margin-top: 5px;">
                Min: <span id="distance-min-display">5</span> miles | Max: <span id="distance-max-display">20</span> miles
            </div>
        </div>
        
        <div class="control-group">
            <label>Heatmap Mode:</label>
            <div style="margin-top: 5px;">
                <label style="display: block; margin-bottom: 3px;">
                    <input type="radio" name="heatmap-mode" value="enrollment" checked onchange="switchHeatmapMode()"> 
                    Enrollment Score
                </label>
                <label style="display: block; margin-bottom: 3px;">
                    <input type="radio" name="heatmap-mode" value="kids500k" onchange="switchHeatmapMode()"> 
                    Kids >$500k
                </label>
                <label style="display: block; margin-bottom: 3px;">
                    <input type="radio" name="heatmap-mode" value="income" onchange="switchHeatmapMode()"> 
                    Median Income
                </label>
                <label style="display: block; margin-bottom: 3px;">
                    <input type="radio" name="heatmap-mode" value="homevalue" onchange="switchHeatmapMode()"> 
                    Median Home Value
                </label>
                <label style="display: block; margin-bottom: 3px;">
                    <input type="radio" name="heatmap-mode" value="composite" onchange="switchHeatmapMode()"> 
                    Composite Score
                </label>
            </div>
        </div>
        
        <div class="legend">
            <div id="legend-title" style="font-weight: bold; margin-bottom: 8px;">Enrollment Score Legend</div>
            <div id="legend-items">
                <div class="legend-item">
                    <span class="legend-color" style="background: #ff0000;"></span>
                    <span>5000+ (Excellent)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ff8000;"></span>
                    <span>3000-4999 (Very Good)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ffff00;"></span>
                    <span>2500-2999 (Good)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #80ff00;"></span>
                    <span>1500-2499 (Fair)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #00ff00;"></span>
                    <span>500-1499 (Moderate)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #00ffff;"></span>
                    <span>0-499 (Low)</span>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <button id="recalculate-btn" class="control-button recalculate-btn" onclick="recalculateMap()">Recalculate Map</button>
            <button id="reset-btn" class="control-button reset-btn" onclick="resetSliders()">Reset to Defaults</button>
        </div>
        
        <!-- Progress bar for large recalculations -->
        <div id="progress-container" style="display: none; margin-top: 10px;">
            <div style="font-size: 12px; margin-bottom: 5px;">
                <span id="progress-text">Processing tracts...</span>
            </div>
            <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden; height: 20px;">
                <div id="progress-bar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>
        
        <div class="control-group">
            <label>
                <input type="checkbox" id="show-schools" onchange="toggleSchoolMarkers()"> 
                Show School Locations
            </label>
        </div>
        
        <div class="control-group">
            <label for="address-search">Search Address:</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="address-search" placeholder="Enter address..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <button onclick="searchAddress()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
            </div>
            <div id="search-results" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
        </div>

        <div class="control-group">
            <label for="state-jump-selector">Jump to State:</label>
            <select id="state-jump-selector" onchange="jumpToState()">
                <option value="">Select a state...</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="state-selector">Select States to Load:</label>
            <div id="state-selector" class="state-selector">
                <!-- States will be populated here -->
            </div>
            <button onclick="loadSelectedStates()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Load Selected States</button>
            <button onclick="clearAllStates()" style="margin-top: 5px; margin-left: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear All</button>
        </div>
        
        
        <div class="stats" id="stats">
            <strong>Loaded Data:</strong><br>
            Schools: <span id="school-count">0</span><br>
            Census Tracts: <span id="tract-count">0</span><br>
            States: <span id="state-count">0</span>
        </div>
        
        <div style="margin-top: 15px;">
            <div style="font-weight: bold; margin-bottom: 5px;">Instructions</div>
            <div style="font-size: 11px; color: #666;">
                • Select states to load census tract data<br>
                • Click census tracts to see school contributions<br>
                • School markers: Color = tuition, Size = enrollment<br>
                • Change tuition to see market viability
            </div>
        </div>
        
        <div class="tract-details" id="tract-details">
            <div>Select states above, then click on a census tract to see enrollment score breakdown</div>
        </div>
    </div>

    <script>
        let map;
        let schoolLayer;
        // allSchoolsData is loaded from us_schools_data.js
        let geojsonLayers = new Map(); // Store layers by state
        let loadedStates = new Set(); // Track which states are loaded
        let tractScores = new Map(); // Cache for calculated scores
        let demographicData = new Map(); // Store demographic data by geoid
        let kids500kData = new Map(); // Store Kids >$500k data by geoid
        let currentHeatmapMode = 'enrollment'; // Current visualization mode
        let currentPercentiles = {}; // Store percentiles for current loaded states
        let selectedTract = null; // Currently selected tract for highlighting
        let searchMarkers = []; // Store search result markers
        
        // Multiplier settings (shifted up one level)
        let incomeMultiplier = 3.0; // Default moderate approach (was aggressive)
        let homeValueMultiplier = 15.0; // Default moderate approach (was aggressive)
        
        // US state codes for organization
        const US_STATES = [
            'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
            'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
            'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
            'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
            'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
        ];

        // Metro areas data (from Metros.csv)
        const metroAreas = [
            {name: "AL - Auburn", lat: 32.60805265, lng: -85.48021403},
            {name: "AL - Birmingham", lat: 33.52041352, lng: -86.81081175},
            {name: "AL - Huntsville", lat: 34.72910749, lng: -86.58535127},
            {name: "AR - Fayetteville", lat: 36.06185147, lng: -94.160475},
            {name: "AR - Little Rock", lat: 34.74928984, lng: -92.27501249},
            {name: "AZ - Phoenix", lat: 33.45881112, lng: -112.045302},
            {name: "AZ - Tucson", lat: 32.23496173, lng: -110.9633417},
            {name: "CA - Los Angeles", lat: 34.01424789, lng: -118.241692},
            {name: "CA - Sacramento", lat: 38.58258529, lng: -121.4930212},
            {name: "CA - San Diego", lat: 32.71746703, lng: -117.1626718},
            {name: "CO - Colorado Springs", lat: 38.83667581, lng: -104.8188904},
            {name: "CO - Denver", lat: 39.7392634, lng: -104.9933661},
            {name: "CT - Hartford", lat: 41.76371109, lng: -72.68509259},
            {name: "FL - Jacksonville", lat: 30.33218085, lng: -81.65565099},
            {name: "FL - Miami", lat: 25.77481011, lng: -80.19362119},
            {name: "FL - Orlando", lat: 28.53823972, lng: -81.37924057},
            {name: "FL - Tampa", lat: 27.94653595, lng: -82.45927932},
            {name: "GA - Atlanta", lat: 33.74831106, lng: -84.39111311},
            {name: "IL - Chicago", lat: 41.88415055, lng: -87.63241697},
            {name: "IN - Indianapolis", lat: 39.76691787, lng: -86.14996716},
            {name: "MA - Boston", lat: 42.35843106, lng: -71.06281616},
            {name: "MD - Baltimore", lat: 39.29058148, lng: -76.6108073},
            {name: "MI - Detroit", lat: 42.33168811, lng: -83.04792957},
            {name: "MN - Minneapolis", lat: 44.97720941, lng: -93.26499197},
            {name: "NC - Charlotte", lat: 35.22708834, lng: -80.84312926},
            {name: "NC - Raleigh", lat: 35.78043077, lng: -78.64001905},
            {name: "NJ - Newark", lat: 40.73587052, lng: -74.17428944},
            {name: "NY - New York", lat: 40.71455592, lng: -74.00714636},
            {name: "OH - Cincinnati", lat: 39.10713046, lng: -84.50413223},
            {name: "OH - Cleveland", lat: 41.50471256, lng: -81.69074128},
            {name: "OH - Columbus", lat: 39.96118804, lng: -82.99879438},
            {name: "PA - Philadelphia", lat: 39.95228964, lng: -75.16522775},
            {name: "PA - Pittsburgh", lat: 40.44089817, lng: -79.99589536},
            {name: "TX - Austin", lat: 30.27467051, lng: -97.74026946},
            {name: "TX - Dallas", lat: 32.78014463, lng: -96.80045665},
            {name: "TX - Houston", lat: 29.76045894, lng: -95.36980671},
            {name: "TX - San Antonio", lat: 29.42458803, lng: -98.49629175},
            {name: "VA - Virginia Beach", lat: 36.85293758, lng: -75.97799451},
            {name: "WA - Seattle", lat: 47.60356432, lng: -122.3295637}
        ];
        
        // Initialize map
        function initMap() {
            // Create map centered on Massachusetts
            map = L.map('map').setView([42.3601, -71.0589], 8); // Center of Massachusetts
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OpenStreetMap contributors'
            }).addTo(map);
            
            // Viewport tracking disabled to reduce memory usage
            // map.on('moveend zoomend', function() {
            //     updateViewportStates();
            // });
            
            // Create school markers from all US data
            createSchoolMarkers();
            
            
            // Populate state jump selector
            populateStateJumpSelector();
            
            // Populate state selector
            populateStateSelector();
            
            // Initialize slider values after a short delay to ensure DOM is ready
            setTimeout(function() {
                updateTuitionValue();
                updateTuitionScalingValue();
                updateDistanceRange();
            }, 100);
            
            // Auto-load Massachusetts on startup
            setTimeout(function() {
                // Check MA checkbox and load it
                const maCheckbox = document.querySelector('input[value="MA"]');
                if (maCheckbox) {
                    maCheckbox.checked = true;
                    updateLoadButton();
                    loadStateTracts('MA');
                }
            }, 300);
            
            // Initialize school visibility (unchecked by default)
            setTimeout(function() {
                initializeSchoolVisibility();
            }, 400);
            
            // Update stats
            updateStats();
        }
        
        // Viewport-driven state management
        let isRecalculating = false;
        
        // Get states that intersect with current viewport
        function getStatesInViewport() {
            const bounds = map.getBounds();
            const visibleStates = [];
            
            usStates.forEach(state => {
                // Simple bounds check - if state center is within expanded bounds
                const expandedBounds = bounds.pad(0.2); // Add 20% buffer
                if (expandedBounds.contains([state.lat, state.lng])) {
                    visibleStates.push(state.abbr);
                }
            });
            
            return visibleStates;
        }
        
        // Update loaded states based on viewport
        async function updateViewportStates() {
            if (isRecalculating) return; // Don't update during recalculation
            
            const visibleStates = getStatesInViewport();
            const currentlyLoaded = Array.from(loadedStates);
            
            
            for (const state of visibleStates) {
                if (!loadedStates.has(state)) {
                    console.log(`Auto-loading state: ${state}`);
                    await loadStateTracts(state);
                }
            }
            
            // Unload distant states (keep a buffer)
            const bounds = map.getBounds();
            const expandedBounds = bounds.pad(0.5); // Larger buffer for unloading
            
            for (const state of currentlyLoaded) {
                const stateData = usStates.find(s => s.abbr === state);
                if (stateData && !expandedBounds.contains([stateData.lat, stateData.lng])) {
                    console.log(`Auto-unloading distant state: ${state}`);
                    unloadState(state);
                }
            }
            
            updateStats();
        }
        
        // Unload a state's census tracts
        function unloadState(stateCode) {
            if (loadedStates.has(stateCode)) {
                // Remove tract layers from map
                if (geojsonLayers.has(stateCode)) {
                    map.removeLayer(geojsonLayers.get(stateCode));
                    geojsonLayers.delete(stateCode);
                }
                
                // Remove from loaded states
                loadedStates.delete(stateCode);
                
                // Clear cached scores for this state
                const keysToDelete = [];
                for (const key of tractScores.keys()) {
                    if (key.includes(`_${stateCode}_`)) {
                        keysToDelete.push(key);
                    }
                }
                keysToDelete.forEach(key => tractScores.delete(key));
                
                console.log(`Auto-unloaded ${stateCode} census tracts`);
            }
        }

        
        // US States for quick navigation (sorted by abbreviation)
        const usStates = [
            {abbr: "AK", name: "Alaska", lat: 61.2181, lng: -149.9003},
            {abbr: "AL", name: "Alabama", lat: 32.3617, lng: -86.2792},
            {abbr: "AR", name: "Arkansas", lat: 34.7465, lng: -92.2896},
            {abbr: "AZ", name: "Arizona", lat: 33.4484, lng: -112.0740},
            {abbr: "CA", name: "California", lat: 36.7783, lng: -119.4179},
            {abbr: "CO", name: "Colorado", lat: 39.5501, lng: -105.7821},
            {abbr: "CT", name: "Connecticut", lat: 41.6032, lng: -73.0877},
            {abbr: "DC", name: "District of Columbia", lat: 38.9072, lng: -77.0369},
            {abbr: "DE", name: "Delaware", lat: 39.3185, lng: -75.5071},
            {abbr: "FL", name: "Florida", lat: 27.7663, lng: -81.6868},
            {abbr: "GA", name: "Georgia", lat: 33.7490, lng: -84.3880},
            {abbr: "HI", name: "Hawaii", lat: 21.0943, lng: -157.4983},
            {abbr: "IA", name: "Iowa", lat: 42.0115, lng: -93.2105},
            {abbr: "ID", name: "Idaho", lat: 44.2405, lng: -114.4788},
            {abbr: "IL", name: "Illinois", lat: 40.3495, lng: -88.9861},
            {abbr: "IN", name: "Indiana", lat: 39.8494, lng: -86.2583},
            {abbr: "KS", name: "Kansas", lat: 38.5266, lng: -96.7265},
            {abbr: "KY", name: "Kentucky", lat: 37.6681, lng: -84.6701},
            {abbr: "LA", name: "Louisiana", lat: 31.1695, lng: -91.8678},
            {abbr: "MA", name: "Massachusetts", lat: 42.2081, lng: -71.0275},
            {abbr: "MD", name: "Maryland", lat: 39.0639, lng: -76.8021},
            {abbr: "ME", name: "Maine", lat: 44.6939, lng: -69.3819},
            {abbr: "MI", name: "Michigan", lat: 43.3266, lng: -84.5361},
            {abbr: "MN", name: "Minnesota", lat: 45.6945, lng: -93.9002},
            {abbr: "MO", name: "Missouri", lat: 38.4561, lng: -92.2884},
            {abbr: "MS", name: "Mississippi", lat: 32.7767, lng: -89.6711},
            {abbr: "MT", name: "Montana", lat: 47.0527, lng: -110.2140},
            {abbr: "NC", name: "North Carolina", lat: 35.5397, lng: -79.8431},
            {abbr: "ND", name: "North Dakota", lat: 47.5289, lng: -99.7840},
            {abbr: "NE", name: "Nebraska", lat: 41.1254, lng: -98.2681},
            {abbr: "NH", name: "New Hampshire", lat: 43.4525, lng: -71.5639},
            {abbr: "NJ", name: "New Jersey", lat: 40.2989, lng: -74.5210},
            {abbr: "NM", name: "New Mexico", lat: 34.8405, lng: -106.2485},
            {abbr: "NV", name: "Nevada", lat: 38.3135, lng: -117.0554},
            {abbr: "NY", name: "New York", lat: 42.1657, lng: -74.9481},
            {abbr: "OH", name: "Ohio", lat: 40.3888, lng: -82.7649},
            {abbr: "OK", name: "Oklahoma", lat: 35.5653, lng: -96.9289},
            {abbr: "OR", name: "Oregon", lat: 44.5672, lng: -122.1269},
            {abbr: "PA", name: "Pennsylvania", lat: 40.5908, lng: -77.2098},
            {abbr: "RI", name: "Rhode Island", lat: 41.6809, lng: -71.5118},
            {abbr: "SC", name: "South Carolina", lat: 33.8569, lng: -80.9450},
            {abbr: "SD", name: "South Dakota", lat: 44.2998, lng: -99.4388},
            {abbr: "TN", name: "Tennessee", lat: 35.7478, lng: -86.6923},
            {abbr: "TX", name: "Texas", lat: 31.0545, lng: -97.5635},
            {abbr: "UT", name: "Utah", lat: 40.1500, lng: -111.8947},
            {abbr: "VA", name: "Virginia", lat: 37.7693, lng: -78.1700},
            {abbr: "VT", name: "Vermont", lat: 44.0459, lng: -72.7107},
            {abbr: "WA", name: "Washington", lat: 47.4009, lng: -121.4905},
            {abbr: "WI", name: "Wisconsin", lat: 44.2685, lng: -89.6165},
            {abbr: "WV", name: "West Virginia", lat: 38.4912, lng: -80.9540},
            {abbr: "WY", name: "Wyoming", lat: 42.7559, lng: -107.3025}
        ];
        
        // State neighbors mapping for smart loading
        const stateNeighbors = {
            'AL': ['FL', 'GA', 'MS', 'TN'],
            'AK': [], // No neighbors
            'AZ': ['CA', 'CO', 'NM', 'NV', 'UT'],
            'AR': ['LA', 'MO', 'MS', 'OK', 'TN', 'TX'],
            'CA': ['AZ', 'NV', 'OR'],
            'CO': ['AZ', 'KS', 'NE', 'NM', 'OK', 'UT', 'WY'],
            'CT': ['MA', 'NY', 'RI'],
            'DE': ['MD', 'NJ', 'PA'],
            'FL': ['AL', 'GA'],
            'GA': ['AL', 'FL', 'NC', 'SC', 'TN'],
            'HI': [], // No neighbors
            'ID': ['MT', 'NV', 'OR', 'UT', 'WA', 'WY'],
            'IL': ['IN', 'IA', 'KY', 'MO', 'WI'],
            'IN': ['IL', 'KY', 'MI', 'OH'],
            'IA': ['IL', 'MN', 'MO', 'NE', 'SD', 'WI'],
            'KS': ['CO', 'MO', 'NE', 'OK'],
            'KY': ['IL', 'IN', 'MO', 'OH', 'TN', 'VA', 'WV'],
            'LA': ['AR', 'MS', 'TX'],
            'ME': ['NH'],
            'MD': ['DE', 'PA', 'VA', 'WV', 'DC'],
            'MA': ['CT', 'NH', 'NY', 'RI', 'VT'],
            'MI': ['IN', 'OH', 'WI'],
            'MN': ['IA', 'ND', 'SD', 'WI'],
            'MS': ['AL', 'AR', 'LA', 'TN'],
            'MO': ['AR', 'IL', 'IA', 'KS', 'KY', 'NE', 'OK', 'TN'],
            'MT': ['ID', 'ND', 'SD', 'WY'],
            'NE': ['CO', 'IA', 'KS', 'MO', 'SD', 'WY'],
            'NV': ['AZ', 'CA', 'ID', 'OR', 'UT'],
            'NH': ['MA', 'ME', 'VT'],
            'NJ': ['DE', 'NY', 'PA'],
            'NM': ['AZ', 'CO', 'OK', 'TX', 'UT'],
            'NY': ['CT', 'MA', 'NJ', 'PA', 'VT'],
            'NC': ['GA', 'SC', 'TN', 'VA'],
            'ND': ['MN', 'MT', 'SD'],
            'OH': ['IN', 'KY', 'MI', 'PA', 'WV'],
            'OK': ['AR', 'CO', 'KS', 'MO', 'NM', 'TX'],
            'OR': ['CA', 'ID', 'NV', 'WA'],
            'PA': ['DE', 'MD', 'NJ', 'NY', 'OH', 'WV'],
            'RI': ['CT', 'MA'],
            'SC': ['GA', 'NC'],
            'SD': ['IA', 'MN', 'MT', 'NE', 'ND', 'WY'],
            'TN': ['AL', 'AR', 'GA', 'KY', 'MO', 'MS', 'NC', 'VA'],
            'TX': ['AR', 'LA', 'NM', 'OK'],
            'UT': ['AZ', 'CO', 'ID', 'NV', 'NM', 'WY'],
            'VT': ['MA', 'NH', 'NY'],
            'VA': ['KY', 'MD', 'NC', 'TN', 'WV', 'DC'],
            'WA': ['ID', 'OR'],
            'WV': ['KY', 'MD', 'OH', 'PA', 'VA'],
            'WI': ['IL', 'IA', 'MI', 'MN'],
            'WY': ['CO', 'ID', 'MT', 'NE', 'SD', 'UT'],
            'DC': ['MD', 'VA']
        };
        
        // Populate state jump selector
        function populateStateJumpSelector() {
            const selector = document.getElementById('state-jump-selector');
            
            usStates.forEach(state => {
                const option = document.createElement('option');
                option.value = `${state.lat},${state.lng}`;
                option.textContent = `${state.abbr} - ${state.name}`;
                selector.appendChild(option);
            });
        }
        
        // Jump to selected state and load it
        async function jumpToState() {
            const selector = document.getElementById('state-jump-selector');
            const value = selector.value;
            
            if (value) {
                const [lat, lng] = value.split(',').map(Number);
                
                // Get the state abbreviation from the selector text
                const selectedOption = selector.options[selector.selectedIndex];
                const stateAbbr = selectedOption.textContent.split(' - ')[0];
                
                // Jump to the state
                map.setView([lat, lng], 7);  // State-level zoom
                
                // Load the state if not already loaded
                if (!loadedStates.has(stateAbbr)) {
                    console.log(`Auto-loading ${stateAbbr} after jump`);
                    
                    // Show loading indicator
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('loading').innerHTML = `Loading ${stateAbbr}...`;
                    
                    await loadStateTracts(stateAbbr);
                    
                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';
                    
                    // Check the checkbox for this state
                    const checkbox = document.querySelector(`input[value="${stateAbbr}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        updateLoadButton();
                    }
                    
                    // Update stats (no recalculation needed - tracts are already styled during loading)
                    updateStats();
                }
                
                // Reset selector
                selector.value = '';
            }
        }
        
        // Populate state selector checkboxes
        function populateStateSelector() {
            const selector = document.getElementById('state-selector');
            
            // Count schools by state
            const stateCounts = {};
            allSchoolsData.forEach(school => {
                stateCounts[school.state] = (stateCounts[school.state] || 0) + 1;
            });
            
            // Create checkboxes for each state (sorted alphabetically)
            usStates.forEach(state => {
                const count = stateCounts[state.abbr] || 0;
                const div = document.createElement('div');
                div.innerHTML = `
                    <label>
                        <input type="checkbox" value="${state.abbr}" onchange="updateLoadButton()">
                        ${state.abbr} - ${state.name} (${count} schools)
                    </label>
                `;
                selector.appendChild(div);
            });
        }
        
        // Update load button text based on selected states
        function updateLoadButton() {
            const checkboxes = document.querySelectorAll('#state-selector input[type="checkbox"]:checked');
            const button = document.querySelector('button[onclick="loadSelectedStates()"]');
            
            if (checkboxes.length === 0) {
                button.textContent = 'Load Selected States';
            } else {
                button.textContent = `Load ${checkboxes.length} Selected State${checkboxes.length > 1 ? 's' : ''}`;
            }
        }
        
        // Load selected states
        async function loadSelectedStates() {
            const checkboxes = document.querySelectorAll('#state-selector input[type="checkbox"]:checked');
            const selectedStates = Array.from(checkboxes).map(cb => cb.value);
            const currentlyLoaded = Array.from(loadedStates);
            
            if (selectedStates.length === 0) {
                alert('Please select at least one state to load.');
                return;
            }
            
            console.log(`Managing states - Selected: ${selectedStates.length}, Currently loaded: ${currentlyLoaded.length}`);
            
            // Show loading indicator
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerHTML = `Updating ${selectedStates.length} state(s)...`;
            
            // First, unload states that are loaded but not selected
            const statesToUnload = currentlyLoaded.filter(state => !selectedStates.includes(state));
            for (const state of statesToUnload) {
                console.log(`Unloading unchecked state: ${state}`);
                unloadState(state);
            }
            
            // Then, load states that are selected but not loaded
            const statesToLoad = selectedStates.filter(state => !loadedStates.has(state));
            for (const state of statesToLoad) {
                console.log(`Loading new state: ${state}`);
                await loadStateTracts(state);
            }
            
            // Hide loading indicator
            document.getElementById('loading').style.display = 'none';
            
            // Update stats and recalculate percentiles for current mode
            updateStats();
            calculatePercentiles();
            updateLegend();
        }
        
        // Clear all loaded states
        function clearAllStates() {
            // Remove all layers
            geojsonLayers.forEach((layer, state) => {
                map.removeLayer(layer);
            });
            
            // Clear data structures
            geojsonLayers.clear();
            loadedStates.clear();
            tractScores.clear();
            
            // Update stats
            updateStats();
            
            console.log('All states cleared');
        }

        // Create school markers for all US schools
        function createSchoolMarkers() {
            if (schoolLayer) {
                map.removeLayer(schoolLayer);
            }
            
            const markers = allSchoolsData.map(school => {
                const radius = Math.max(4, Math.sqrt(school.enrollment) / 2);
                const marker = L.circleMarker([school.lat, school.lng], {
                    radius: radius,
                    fillColor: getSchoolColor(school.tuition),
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <div style="font-size: 14px; max-width: 250px;">
                        <strong>${school.name}</strong><br>
                        <strong>City:</strong> ${school.city}, ${school.state}<br>
                        <strong>Enrollment:</strong> ${school.enrollment}<br>
                        <strong>Tuition:</strong> $${school.tuition.toLocaleString()}<br>
                    </div>
                `);
                
                return marker;
            });
            
            schoolLayer = L.layerGroup(markers).addTo(map);
            
            // Ensure school markers stay on top
            schoolLayer.eachLayer(function(marker) {
                marker.bringToFront();
            });
        }

        

        // Load census tracts for a specific state
        async function loadStateTracts(stateCode) {
            try {
                console.log(`Loading census tracts for ${stateCode}...`);
                const response = await fetch(`census_tracts/${stateCode}.geojson`);
                
                if (!response.ok) {
                    console.warn(`Census tract data not found for ${stateCode}`);
                    return;
                }
                
                const geojsonData = await response.json();
                
                const layer = L.geoJSON(geojsonData, {
                    style: tractStyle,
                    onEachFeature: onEachTract
                });
                layer.setStyle(tractStyle);
                layer.addTo(map);
                
                // Apply consistent styling with progress bar for large states
                const tractLayers = layer.getLayers();
                const tractCount = tractLayers.length;
                
                if (tractCount > 1000) {
                    // Show progress bar for large states
                    const progressContainer = document.getElementById('progress-container');
                    const progressBar = document.getElementById('progress-bar');
                    const progressText = document.getElementById('progress-text');
                    
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressText.textContent = `Styling ${stateCode} tracts...`;
                    
                    // Process in batches with progress updates
                    const batchSize = 200;
                    for (let i = 0; i < tractLayers.length; i += batchSize) {
                        const batch = tractLayers.slice(i, i + batchSize);
                        
                        batch.forEach(sublayer => {
                            const value = getTractValue(sublayer.feature);
                            const color = getTractColor(value);
                            sublayer.setStyle({
                                fillColor: color,
                                fillOpacity: 0.4,
                                weight: 1,
                                opacity: 0.8,
                                color: color  // Border color matches tract color
                            });
                        });
                        
                        // Update progress
                        const progress = ((i + batchSize) / tractLayers.length) * 100;
                        progressBar.style.width = Math.min(progress, 100) + '%';
                        progressText.textContent = `Styling ${stateCode} tracts... (${Math.round(Math.min(progress, 100))}%)`;
                        
                        // Yield to UI every batch
                        if (i + batchSize < tractLayers.length) {
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }
                    }
                    
                    // Hide progress bar
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 500);
                } else {
                    // Small states - process normally without progress bar
                    layer.eachLayer(function(sublayer) {
                        const value = getTractValue(sublayer.feature);
                        const color = getTractColor(value);
                        sublayer.setStyle({
                            fillColor: color,
                            fillOpacity: 0.4,
                            weight: 1,
                            opacity: 0.8,
                            color: color  // Border color matches tract color
                        });
                    });
                }
                
                geojsonLayers.set(stateCode, layer);
                loadedStates.add(stateCode);
                
                // Ensure school markers stay on top
                if (schoolLayer) {
                    schoolLayer.eachLayer(function(marker) {
                        marker.bringToFront();
                    });
                }
                
                console.log(`Loaded ${geojsonData.features.length} census tracts for ${stateCode}`);
                
            } catch (error) {
                console.error(`Error loading census tracts for ${stateCode}:`, error);
            }
        }

        // Get color based on current heatmap mode and value
        function getTractColor(value, mode = null) {
            const currentMode = mode || currentHeatmapMode;
            
            switch (currentMode) {
                case 'enrollment':
                    return getEnrollmentColor(value);
                case 'kids500k':
                    return getKids500kColor(value);
                case 'income':
                    return getIncomeColor(value);
                case 'homevalue':
                    return getHomeValueColor(value);
                case 'composite':
                    return getCompositeColor(value);
                default:
                    return getEnrollmentColor(value);
            }
        }
        
        // Get color based on enrollment score with 6 buckets as requested
        function getEnrollmentColor(score) {
            if (score >= 5000) return '#ff0000';      // Red: 5000+ (Excellent)
            if (score >= 3000) return '#ff8000';      // Orange: 3000-4999 (Very Good)
            if (score >= 2500) return '#ffff00';      // Yellow: 2500-2999 (Good)
            if (score >= 1500) return '#80ff00';      // Light green: 1500-2499 (Fair)
            if (score >= 500) return '#00ffff';       // Blue: 500-1499 (Moderate)
            return 'transparent';                     // Transparent: 0-499 (Low)
        }
        
        // Get color based on kids >$500k count using new breakpoints
        function getKids500kColor(count) {
            if (count >= 1500) return '#ff0000';      // Red: 1500+ (Excellent)
            if (count >= 1000) return '#ff8000';      // Orange: 1000-1499 (Very Good)
            if (count >= 500) return '#ffff00';       // Yellow: 500-999 (Good)
            if (count >= 250) return '#80ff00';       // Light green: 250-499 (Fair)
            if (count >= 100) return '#00ffff';       // Blue: 100-249 (Moderate)
            return 'transparent';                     // Transparent: <100 (Low)
        }
        
        // Get color based on median household income using dynamic tuition-based breakpoints
        function getIncomeColor(income) {
            const tuition = parseInt(document.getElementById('tuition-slider').value);
            
            // Dynamic multipliers based on user selection
            const redThreshold = tuition * incomeMultiplier;                    // Excellent
            const orangeThreshold = tuition * (incomeMultiplier * 0.8);         // Very Good: 80% of excellent
            const yellowThreshold = tuition * (incomeMultiplier * 0.6);         // Good: 60% of excellent  
            const greenThreshold = tuition * (incomeMultiplier * 0.5);          // Fair: 50% of excellent
            const blueThreshold = tuition * (incomeMultiplier * 0.4);           // Moderate: 40% of excellent
            
            if (income >= redThreshold) return '#ff0000';      // Red: Excellent
            if (income >= orangeThreshold) return '#ff8000';   // Orange: Very Good
            if (income >= yellowThreshold) return '#ffff00';   // Yellow: Good
            if (income >= greenThreshold) return '#80ff00';    // Light green: Fair
            if (income >= blueThreshold) return '#00ffff';     // Blue: Moderate
            return 'transparent';                              // Transparent: Low
        }
        
        // Get color based on median home value using dynamic tuition-based breakpoints
        function getHomeValueColor(value) {
            const tuition = parseInt(document.getElementById('tuition-slider').value);
            
            // Dynamic multipliers based on user selection
            const redThreshold = tuition * homeValueMultiplier;                    // Excellent
            const orangeThreshold = tuition * (homeValueMultiplier * 0.83);        // Very Good: 83% of excellent
            const yellowThreshold = tuition * (homeValueMultiplier * 0.625);       // Good: 62.5% of excellent
            const greenThreshold = tuition * (homeValueMultiplier * 0.5);          // Fair: 50% of excellent
            const blueThreshold = tuition * (homeValueMultiplier * 0.42);          // Moderate: 42% of excellent
            
            if (value >= redThreshold) return '#ff0000';      // Red: Excellent
            if (value >= orangeThreshold) return '#ff8000';   // Orange: Very Good
            if (value >= yellowThreshold) return '#ffff00';   // Yellow: Good
            if (value >= greenThreshold) return '#80ff00';    // Light green: Fair
            if (value >= blueThreshold) return '#00ffff';     // Blue: Moderate
            return 'transparent';                             // Transparent: Low
        }
        
        // Get color based on composite score
        function getCompositeColor(score) {
            if (score >= 4) return '#ff0000';         // Red: Score 4 (Excellent)
            if (score >= 3) return '#ff8000';         // Orange: Score 3 (Very Good)
            if (score >= 2) return '#ffff00';         // Yellow: Score 2 (Good)
            if (score >= 1) return '#80ff00';         // Light green: Score 1 (Fair)
            return 'transparent';                     // Transparent: Score 0 (Low)
        }
        
        // Calculate composite score for a tract
        function calculateCompositeScore(feature) {
            const geoid = feature.properties.GEOID;
            
            // Get individual metric scores (0-5 points each)
            const tuition = parseInt(document.getElementById('tuition-slider').value);
            const enrollmentValue = calculateTractScore(feature, tuition);
            const enrollmentScore = getMetricPoints(enrollmentValue, 'enrollment');
            
            // Get Kids >$500k score with spatial fallback
            let kids500kValue = kids500kData.get(geoid);
            if (!kids500kValue || kids500kValue === 0) {
                kids500kValue = getKids500kBySpatial(feature);
            }
            const kids500kScore = getMetricPoints(kids500kValue || 0, 'kids500k');
            
            const demoData = demographicData.get(geoid);
            const incomeScore = getMetricPoints(demoData?.median_hh_income || 0, 'income');
            const homeValueScore = getMetricPoints(demoData?.median_home_value || 0, 'homevalue');
            
            // Handle missing data by treating as 0 (no contribution to score)
            const scores = [enrollmentScore, kids500kScore, incomeScore, homeValueScore];
            
            // Total points out of 20 (4 metrics × 5 points)
            const totalPoints = scores.reduce((sum, score) => sum + score, 0);
            
            // Convert to 0-4 scale (back to 4 metrics)
            if (totalPoints >= 18) return 4;  // Excellent (mostly red) - 18-20 points
            if (totalPoints >= 14) return 3;  // Very Good (mix red/orange) - 14-17 points  
            if (totalPoints >= 10) return 2;  // Good (solid yellow+) - 10-13 points
            if (totalPoints >= 6) return 1;   // Fair - 6-9 points
            return 0;                          // Low - 0-5 points
        }
        
        // Convert metric value to points (0-5)
        function getMetricPoints(value, metric) {
            let color;
            switch (metric) {
                case 'enrollment':
                    color = getEnrollmentColor(value);
                    break;
                case 'kids500k':
                    color = getKids500kColor(value);
                    break;
                case 'income':
                    color = getIncomeColor(value);
                    break;
                case 'homevalue':
                    color = getHomeValueColor(value);
                    break;
                default:
                    return 0;
            }
            
            // Convert color to points
            if (color === '#ff0000') return 5;      // Red
            if (color === '#ff8000') return 4;      // Orange
            if (color === '#ffff00') return 3;      // Yellow
            if (color === '#80ff00') return 2;      // Light green
            if (color === '#00ffff') return 1;      // Blue
            return 0;                               // Transparent or other
        }
        
        // Get color based on percentile position (5 quintiles)
        function getPercentileColor(value, mode) {
            if (!currentPercentiles.p0) {
                return '#cccccc'; // Grey if no percentiles calculated
            }
            
            if (value >= currentPercentiles.p80) return '#ff0000';      // Red: Top 20% (Excellent)
            if (value >= currentPercentiles.p60) return '#ff8000';      // Orange: 60-80% (Very Good)
            if (value >= currentPercentiles.p40) return '#ffff00';      // Yellow: 40-60% (Good)
            if (value >= currentPercentiles.p20) return '#80ff00';      // Light green: 20-40% (Fair)
            if (value >= currentPercentiles.p0) return '#00ffff';       // Blue: 0-20% (Moderate)
            return '#cccccc';                                           // Grey: Below minimum
        }

        // Get school marker color based on tuition with better visibility
        function getSchoolColor(tuition) {
            // Use fixed thresholds for better cross-market comparison
            if (tuition < 10000) return '#2E8B57';      // Sea Green (low)
            if (tuition < 20000) return '#32CD32';      // Lime Green
            if (tuition < 30000) return '#FFD700';      // Gold
            if (tuition < 40000) return '#FF8C00';      // Dark Orange
            if (tuition < 50000) return '#FF4500';      // Orange Red
            if (tuition < 60000) return '#DC143C';      // Crimson
            return '#8B0000';                           // Dark Red (high)
        }

        // Calculate enrollment score for a tract
        function calculateTractScore(tractFeature, tuition) {
            const cacheKey = `${tractFeature.properties.geoid || tractFeature.properties.GEOID}_${tuition}`;
            
            if (tractScores.has(cacheKey)) {
                return tractScores.get(cacheKey);
            }
            
            const result = calculateSchoolContributions(tractFeature, tuition);
            const score = result.totalScore;
            
            tractScores.set(cacheKey, score);
            return score;
        }

        // Calculate school contributions to a census tract
        function calculateSchoolContributions(tractFeature, proposedTuition) {
            const centroid = calculateCentroid(tractFeature.geometry.coordinates);
            const contributions = [];
            let totalScore = 0;

            allSchoolsData.forEach(school => {
                const distance = calculateDistance(centroid.lat, centroid.lng, school.lat, school.lng);
                
                if (distance <= 20) { // Only consider schools within 20 miles
                    const distanceScaling = getDistanceScaling(distance);
                    const tuitionScaling = getTuitionScaling(school.tuition, proposedTuition);
                    const contribution = school.enrollment * distanceScaling * tuitionScaling;
                    
                    if (contribution > 0) {
                        contributions.push({
                            school: school,
                            distance: distance,
                            distanceScaling: distanceScaling,
                            tuitionScaling: tuitionScaling,
                            contribution: contribution
                        });
                        totalScore += contribution;
                    }
                }
            });

            contributions.sort((a, b) => b.contribution - a.contribution);
            return { contributions, totalScore };
        }

        // Distance and tuition scaling functions (same as Boston version)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getDistanceScaling(distance) {
            const minSlider = document.getElementById('distance-min-slider');
            const maxSlider = document.getElementById('distance-max-slider');
            
            if (!minSlider || !maxSlider) {
                // Fallback to default values if sliders not available
                const minDistance = 5;
                const maxDistance = 20;
                if (distance < minDistance) return 1.0;
                if (distance > maxDistance) return 0.0;
                return 1.0 - (distance - minDistance) / (maxDistance - minDistance);
            }
            
            const minDistance = parseInt(minSlider.value);
            const maxDistance = parseInt(maxSlider.value);
            
            if (distance < minDistance) return 1.0;
            if (distance > maxDistance) return 0.0;
            return 1.0 - (distance - minDistance) / (maxDistance - minDistance);
        }

        function getTuitionScaling(schoolTuition, proposedTuition) {
            if (schoolTuition >= proposedTuition) return 1.0;
            
            const slider = document.getElementById('tuition-scaling-slider');
            const scalingFactor = slider ? parseInt(slider.value) / 100 : 0.25; // Default to 25%
            const minTuition = proposedTuition * scalingFactor;
            
            if (schoolTuition <= minTuition) return 0.0;
            return (schoolTuition - minTuition) / (proposedTuition - minTuition);
        }

        function calculateCentroid(coordinates) {
            let totalLat = 0;
            let totalLng = 0;
            let pointCount = 0;
            
            const coords = coordinates[0]; // Get the outer ring
            coords.forEach(coord => {
                totalLng += coord[0];
                totalLat += coord[1];
                pointCount++;
            });
            
            return {
                lat: totalLat / pointCount,
                lng: totalLng / pointCount
            };
        }

        // Update tract colors based on current parameters
        function updateTractColorsForLoadedStates() {
            const tuitionSlider = document.getElementById('tuition-slider');
            const tuition = tuitionSlider ? parseInt(tuitionSlider.value) : 40000;
            
            // Clear cache since parameters changed
            tractScores.clear();
            
            loadedStates.forEach(state => {
                if (geojsonLayers.has(state)) {
                    geojsonLayers.get(state).eachLayer(function(layer) {
                        const value = getTractValue(layer.feature);
                        const color = getTractColor(value);
                        layer.setStyle({
                            fillColor: color,
                            fillOpacity: 0.4,
                            weight: 1,
                            opacity: 0.8,
                            color: color  // Border color always matches tract color
                        });
                    });
                }
            });
        }
        
        // Alias for backward compatibility
        function updateTractColors() {
            updateTractColorsForLoadedStates();
        }
        
        // Recalculate map with current slider values
        function recalculateMap() {
            const totalTracts = getTotalLoadedTracts();
            
            // Show confirmation dialog for large recalculations
            if (totalTracts > 5000) {
                showRecalculationConfirmation(totalTracts);
            } else {
                performRecalculation();
            }
        }
        
        // Get total number of loaded tracts
        function getTotalLoadedTracts() {
            let total = 0;
            geojsonLayers.forEach(layer => {
                layer.eachLayer(() => total++);
            });
            return total;
        }
        
        // Show confirmation dialog for large recalculations
        function showRecalculationConfirmation(tractCount) {
            const estimatedTime = Math.ceil(tractCount / 1000) * 2; // Rough estimate: 2 seconds per 1000 tracts
            const stateCount = loadedStates.size;
            
            document.getElementById('confirmation-message').innerHTML = `
                Recalculate <strong>${tractCount.toLocaleString()}</strong> tracts across <strong>${stateCount}</strong> states?<br>
                <small style="color: #888;">Estimated time: ${estimatedTime}-${estimatedTime + 5} seconds</small>
            `;
            document.getElementById('confirmation-overlay').style.display = 'block';
        }
        
        // Cancel recalculation
        function cancelRecalculation() {
            document.getElementById('confirmation-overlay').style.display = 'none';
        }
        
        // Proceed with recalculation
        function proceedWithRecalculation() {
            document.getElementById('confirmation-overlay').style.display = 'none';
            performRecalculation();
        }
        
        // Perform the actual recalculation with progress bar
        async function performRecalculation() {
            isRecalculating = true;
            
            const totalTracts = getTotalLoadedTracts();
            if (totalTracts > 2000) {
                await performBatchedRecalculation();
            } else {
                updateTractColorsForLoadedStates();
            }
            
            isRecalculating = false;
        }
        
        // Perform batched recalculation with progress bar
        async function performBatchedRecalculation() {
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            const tuitionSlider = document.getElementById('tuition-slider');
            const tuition = tuitionSlider ? parseInt(tuitionSlider.value) : 40000;
            
            // Clear cache since parameters changed
            tractScores.clear();
            
            let processedTracts = 0;
            let totalTracts = 0;
            
            // Count total tracts
            geojsonLayers.forEach(layer => {
                layer.eachLayer(() => totalTracts++);
            });
            
            // Process each state in batches
            for (const [stateName, layer] of geojsonLayers.entries()) {
                progressText.textContent = `Processing ${stateName}...`;
                
                const stateTractCount = layer.getLayers().length;
                const batchSize = Math.min(500, stateTractCount); // Process in chunks of 500
                const tractLayers = layer.getLayers();
                
                for (let i = 0; i < tractLayers.length; i += batchSize) {
                    const batch = tractLayers.slice(i, i + batchSize);
                    
                    // Process batch
                    batch.forEach(tractLayer => {
                        const value = getTractValue(tractLayer.feature);
                        const color = getTractColor(value);
                        
                        tractLayer.setStyle({
                            fillColor: color,
                            fillOpacity: 0.4,
                            weight: 1,
                            opacity: 0.8,
                            color: color
                        });
                        
                        processedTracts++;
                    });
                    
                    // Update progress
                    const progress = (processedTracts / totalTracts) * 100;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `Processing ${stateName}... (${Math.round(progress)}%)`;
                    
                    // Yield to UI
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            progressText.textContent = 'Complete!';
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 1000);
        }
        
        // Toggle school marker visibility
        function toggleSchoolMarkers() {
            const showSchools = document.getElementById('show-schools').checked;
            
            if (schoolLayer) {
                if (showSchools) {
                    map.addLayer(schoolLayer);
                } else {
                    map.removeLayer(schoolLayer);
                }
            }
        }
        
        // Initialize school visibility on startup
        function initializeSchoolVisibility() {
            // Schools start unchecked, so hide them initially
            if (schoolLayer && map.hasLayer(schoolLayer)) {
                map.removeLayer(schoolLayer);
            }
        }
        
        // Reset sliders to default values
        function resetSliders() {
            document.getElementById('tuition-slider').value = 40000;
            document.getElementById('tuition-scaling-slider').value = 25;
            document.getElementById('distance-min-slider').value = 5;
            document.getElementById('distance-max-slider').value = 20;
            
            updateTuitionValue();
            updateTuitionScalingValue();
            updateDistanceRange();
        }
        

        // Update slider display values
        function updateTuitionValue() {
            const slider = document.getElementById('tuition-slider');
            const display = document.getElementById('tuition-value');
            if (!slider || !display) return;
            
            const value = slider.value;
            display.textContent = '$' + parseInt(value).toLocaleString();
        }
        
        function updateTuitionScalingValue() {
            const slider = document.getElementById('tuition-scaling-slider');
            const display = document.getElementById('tuition-scaling-value');
            if (!slider || !display) return;
            
            const value = slider.value;
            display.textContent = value + '%';
        }
        
        function updateDistanceRange() {
            const minSlider = document.getElementById('distance-min-slider');
            const maxSlider = document.getElementById('distance-max-slider');
            const rangeDisplay = document.getElementById('distance-range-value');
            const minDisplay = document.getElementById('distance-min-display');
            const maxDisplay = document.getElementById('distance-max-display');
            const track = document.getElementById('range-track');
            
            if (!minSlider || !maxSlider || !rangeDisplay || !minDisplay || !maxDisplay || !track) return;
            
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);
            
            // Ensure min <= max
            if (minVal >= maxVal) {
                if (minSlider === document.activeElement) {
                    maxVal = minVal + 1;
                    maxSlider.value = maxVal;
                } else {
                    minVal = maxVal - 1;
                    minSlider.value = minVal;
                }
            }
            
            // Update displays
            rangeDisplay.textContent = `${minVal}-${maxVal} miles`;
            minDisplay.textContent = minVal;
            maxDisplay.textContent = maxVal;
            
            // Update track visual
            const minPercent = ((minVal - 1) / (30 - 1)) * 100;
            const maxPercent = ((maxVal - 1) / (30 - 1)) * 100;
            track.style.left = minPercent + '%';
            track.style.width = (maxPercent - minPercent) + '%';
        }

        // Style census tracts with borders matching tract color
        function tractStyle(feature) {
            const value = getTractValue(feature);
            const tractColor = getTractColor(value);
            
            return {
                fillColor: tractColor,
                weight: 1,
                opacity: 0.8,
                color: tractColor,  // Border color matches tract color for seamless appearance
                fillOpacity: 0.4
            };
        }
        
        // Get the appropriate value for the current heatmap mode
        function getTractValue(feature) {
            const geoid = feature.properties.GEOID;
            
            switch (currentHeatmapMode) {
                case 'kids500k':
                    // Try GEOID first, then spatial fallback
                    let kids500kValue = kids500kData.get(geoid);
                    if (!kids500kValue || kids500kValue === 0) {
                        kids500kValue = getKids500kBySpatial(feature);
                    }
                    return kids500kValue || 0;
                    
                case 'income':
                    const incomeData = demographicData.get(geoid);
                    return incomeData ? incomeData.median_hh_income : 0;
                    
                case 'homevalue':
                    const homeData = demographicData.get(geoid);
                    return homeData ? homeData.median_home_value : 0;
                    
                case 'composite':
                    return calculateCompositeScore(feature);
                    
                default:
                    const defaultTuition = parseInt(document.getElementById('tuition-slider').value);
                    return calculateTractScore(feature, defaultTuition);
            }
        }
        
        // Handle each tract feature (for click events)
        function onEachTract(feature, layer) {
            layer.on({
                click: onTractClick
            });
        }
        
        // Get tract style based on current heatmap mode
        function getTractStyle(feature) {
            const value = getTractValue(feature);
            const color = getTractColor(value);
            
            return {
                fillColor: color,
                weight: 1,
                opacity: 1,
                color: '#666',
                fillOpacity: 0.4
            };
        }

        // Handle tract click events
        function onTractClick(e) {
            const feature = e.target.feature;
            const props = feature.properties;
            const geoid = props.geoid || props.GEOID;
            
            // Reset previous selection
            if (selectedTract) {
                selectedTract.setStyle(getTractStyle(selectedTract.feature));
            }
            
            // Highlight selected tract
            e.target.setStyle({
                weight: 3,
                color: '#ff0000',
                fillOpacity: 0.8
            });
            selectedTract = e.target;
            
            // Create popup with tract information
            const tuition = parseInt(document.getElementById('tuition-slider').value);
            const enrollmentScore = calculateTractScore(feature, tuition);
            const enrollmentContributions = calculateSchoolContributions(feature, tuition);
            const demoData = demographicData.get(geoid);
            const income = demoData ? demoData.median_hh_income : 0;
            const homeValue = demoData ? demoData.median_home_value : 0;
            
            // Get Kids >$500k with spatial fallback
            let kids500k = kids500kData.get(geoid);
            if (!kids500k || kids500k === 0) {
                kids500k = getKids500kBySpatial(feature);
            }
            kids500k = kids500k || 0;
            
            const compositeScore = calculateCompositeScore(feature);
            
            // Get colors
            const enrollmentColor = getEnrollmentColor(enrollmentScore);
            const kids500kColor = getKids500kColor(kids500k);
            const incomeColor = getIncomeColor(income);
            const homeValueColor = getHomeValueColor(homeValue);
            const compositeColor = getCompositeColor(compositeScore);
            
            // Create enrollment breakdown
            let enrollmentBreakdown = '';
            if (enrollmentContributions.contributions && enrollmentContributions.contributions.length > 0) {
                const topSchools = enrollmentContributions.contributions
                    .sort((a, b) => b.contribution - a.contribution)
                    .slice(0, 5); // Show top 5 contributing schools
                
                enrollmentBreakdown = `
                    <div style="margin-top: 8px; padding-top: 6px; border-top: 1px solid #eee;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 10px;">Top Contributing Schools:</div>
                        ${topSchools.map(contrib => `
                            <div style="font-size: 9px; margin-bottom: 1px;">
                                • ${contrib.school.name} (${contrib.school.city}): +${contrib.contribution.toFixed(0)}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            const popupContent = `
                <div style="min-width: 280px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">📊 Census Tract Analysis</h4>
                    <div style="font-size: 11px; margin-bottom: 8px; color: #888;">Tract: ${geoid}</div>
                    
                    <div style="background: ${compositeColor}; color: white; padding: 6px; border-radius: 4px; text-align: center; margin-bottom: 8px; font-weight: bold;">
                        <div style="color: white;">
                            <strong>Composite Score: ${compositeScore}</strong>
                        </div>
                    </div>
                    
                    <div style="font-size: 11px; border-top: 1px solid #eee; padding-top: 6px;">
                        <div style="display: flex; align-items: center; margin-bottom: 2px;">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${enrollmentColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            Enrollment: ${enrollmentScore.toLocaleString()}
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 2px;">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${kids500kColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            Kids >$500k: ${kids500k.toLocaleString()}
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 2px;">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${incomeColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            Income: $${income.toLocaleString()}
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${homeValueColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            Home Value: $${homeValue.toLocaleString()}
                        </div>
                        ${enrollmentBreakdown}
                    </div>
                </div>
            `;
            
            // Create popup
            const popup = L.popup()
                .setLatLng(e.latlng)
                .setContent(popupContent)
                .openOn(map);
        }

        function displayTractAnalysis(geoid, result, calculatedScore) {
            const detailsDiv = document.getElementById('tract-details');
            
            const tuition = parseInt(document.getElementById('tuition-slider').value);
            let html = `
                <div><strong>Census Tract:</strong> ${geoid}</div>
                <div><strong>Tuition Level:</strong> $${tuition.toLocaleString()}</div>
                <div class="total-score">
                    <div>Enrollment Score: ${calculatedScore.toFixed(1)}</div>
                </div>
                <div style="margin-top: 15px;"><strong>Top School Contributions:</strong></div>
            `;
            
            if (result.contributions.length === 0) {
                html += '<div style="color: #666; font-style: italic;">No schools contribute to this tract at this tuition level.</div>';
            } else {
                // Show top 10 contributors
                result.contributions.slice(0, 10).forEach(contrib => {
                    const percentage = (contrib.contribution / result.totalScore * 100).toFixed(1);
                    html += `
                        <div class="school-contribution">
                            <div class="school-name">${contrib.school.name}</div>
                            <div class="contribution-details">
                                ${contrib.school.city}, ${contrib.school.state}<br>
                                Contribution: ${contrib.contribution.toFixed(1)} (${percentage}%)<br>
                                Distance: ${contrib.distance.toFixed(1)} miles<br>
                                Tuition: $${contrib.school.tuition.toLocaleString()}
                            </div>
                        </div>
                    `;
                });
                
                if (result.contributions.length > 10) {
                    html += `<div style="font-style: italic; color: #666;">...and ${result.contributions.length - 10} more schools</div>`;
                }
            }
            
            detailsDiv.innerHTML = html;
        }

        function updateStats() {
            document.getElementById('school-count').textContent = allSchoolsData.length.toLocaleString();
            
            let totalTracts = 0;
            geojsonLayers.forEach(layer => {
                layer.eachLayer(() => totalTracts++);
            });
            document.getElementById('tract-count').textContent = totalTracts.toLocaleString();
            document.getElementById('state-count').textContent = loadedStates.size;
        }

        // Initialize everything
        function init() {
            document.getElementById('loading').style.display = 'none';
            initMap();
            loadDemographicData();
            loadKids500kData(); // Load the new Kids >$500k data
            updateLegend(); // Initialize legend with current mode
            setupMultiplierControls(); // Setup new multiplier controls
            
            // No longer needed - using sliders instead of dropdown
        }
        
        // Setup multiplier control event handlers
        function setupMultiplierControls() {
            // Market type dropdown
            document.getElementById('market-type').addEventListener('change', function() {
                const marketType = this.value;
                const customDiv = document.getElementById('custom-multipliers');
                
                if (marketType === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                    // Set predefined multipliers (shifted up one level)
                    switch(marketType) {
                        case 'conservative':
                            incomeMultiplier = 2.5;  // Was moderate
                            homeValueMultiplier = 12.0;
                            break;
                        case 'moderate':
                            incomeMultiplier = 3.0;  // Was aggressive
                            homeValueMultiplier = 15.0;
                            break;
                        case 'aggressive':
                            incomeMultiplier = 3.5;  // Was premium
                            homeValueMultiplier = 18.0;
                            break;
                        case 'premium':
                            incomeMultiplier = 4.0;  // New higher level
                            homeValueMultiplier = 21.0;
                            break;
                    }
                    // Update slider values if in custom mode
                    document.getElementById('income-multiplier').value = incomeMultiplier;
                    document.getElementById('home-multiplier').value = homeValueMultiplier;
                    updateMultiplierDisplays();
                }
                
                // Map will be refreshed when user clicks Recalculate button
            });
            
            // Income multiplier slider
            document.getElementById('income-multiplier').addEventListener('input', function() {
                incomeMultiplier = parseFloat(this.value);
                updateMultiplierDisplays();
            });
            
            // Home value multiplier slider  
            document.getElementById('home-multiplier').addEventListener('input', function() {
                homeValueMultiplier = parseFloat(this.value);
                updateMultiplierDisplays();
            });
        }
        
        // Update multiplier display values
        function updateMultiplierDisplays() {
            document.getElementById('income-multiplier-value').textContent = incomeMultiplier.toFixed(1);
            document.getElementById('home-multiplier-value').textContent = homeValueMultiplier.toFixed(1);
        }
        
        // Refresh map colors when multipliers or tuition change
        function refreshMapColors() {
            // Clear tract score cache since tuition/multipliers changed
            tractScores.clear();
            
            // Refresh all loaded tract layers
            geojsonLayers.forEach((layer, state) => {
                layer.eachLayer(function(tractLayer) {
                    const style = getTractStyle(tractLayer.feature);
                    tractLayer.setStyle(style);
                });
            });
            
            // Update legend to reflect new thresholds
            updateLegend();
        }
        
        // Load Kids >$500k data from CSV with spatial fallback
        async function loadKids500kData() {
            try {
                console.log('Loading Kids >$500k data...');
                const response = await fetch('kids_500k_data.csv');
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                // Store both GEOID and spatial data
                const kids500kSpatial = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const values = line.split(',');
                        const geoid = values[0];
                        const kids500k = parseFloat(values[1]) || 0;
                        const lat = parseFloat(values[2]);
                        const lng = parseFloat(values[3]);
                        
                        // Try GEOID first
                        kids500kData.set(geoid, kids500k);
                        
                        // Also store spatial data for fallback
                        if (!isNaN(lat) && !isNaN(lng)) {
                            kids500kSpatial.push({
                                geoid: geoid,
                                kids500k: kids500k,
                                lat: lat,
                                lng: lng
                            });
                        }
                    }
                }
                
                // Store spatial data globally for fallback lookups
                window.kids500kSpatial = kids500kSpatial;
                
                console.log(`Loaded Kids >$500k data for ${kids500kData.size} census tracts`);
                console.log(`Spatial fallback data available for ${kids500kSpatial.length} tracts`);
            } catch (error) {
                console.error('Error loading Kids >$500k data:', error);
            }
        }
        
        // Spatial lookup function for Kids >$500k data when GEOID fails
        function getKids500kBySpatial(tractFeature) {
            if (!window.kids500kSpatial) return 0;
            
            // Get tract centroid (approximate)
            const bounds = L.geoJSON(tractFeature).getBounds();
            const tractLat = bounds.getCenter().lat;
            const tractLng = bounds.getCenter().lng;
            
            // Find closest Kids >$500k data point (within reasonable distance)
            let closest = null;
            let minDistance = Infinity;
            const maxDistance = 0.01; // ~1km tolerance
            
            for (const point of window.kids500kSpatial) {
                const distance = Math.sqrt(
                    Math.pow(tractLat - point.lat, 2) + 
                    Math.pow(tractLng - point.lng, 2)
                );
                
                if (distance < minDistance && distance < maxDistance) {
                    minDistance = distance;
                    closest = point;
                }
            }
            
            return closest ? closest.kids500k : 0;
        }

        // Load demographic data from CSV
        async function loadDemographicData() {
            try {
                console.log('Loading demographic data...');
                const response = await fetch('acs5_2023_tract_overall.csv');
                const csvText = await response.text();
                
                // Parse CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= headers.length) {
                        const geoid = values[4]; // geoid column
                        demographicData.set(geoid, {
                            median_hh_income: parseFloat(values[5]) || 0,
                            median_home_value: parseFloat(values[7]) || 0,
                            total_pop: parseFloat(values[9]) || 0,
                            kids500k: 0 // Placeholder - will be populated later
                        });
                    }
                }
                
                console.log(`Loaded demographic data for ${demographicData.size} tracts`);
            } catch (error) {
                console.error('Error loading demographic data:', error);
            }
        }
        
        // Switch heatmap visualization mode
        function switchHeatmapMode() {
            const selectedMode = document.querySelector('input[name="heatmap-mode"]:checked').value;
            currentHeatmapMode = selectedMode;
            
            console.log(`Switching to ${selectedMode} heatmap mode`);
            
            // Calculate percentiles for current mode and loaded states
            calculatePercentiles();
            
            // Update legend
            updateLegend();
            
            // Recalculate colors for all loaded tracts
            updateTractColorsForLoadedStates();
        }
        
        // Calculate percentiles for current loaded states and mode
        function calculatePercentiles() {
            if (currentHeatmapMode === 'enrollment') {
                // Enrollment mode uses fixed breakpoints, not percentiles
                return;
            }
            
            const values = [];
            
            // Collect values from all loaded tracts
            loadedStates.forEach(state => {
                if (geojsonLayers.has(state)) {
                    geojsonLayers.get(state).eachLayer(function(layer) {
                        const geoid = layer.feature.properties.GEOID;
                        const demoData = demographicData.get(geoid);
                        
                        if (demoData) {
                            let value = 0;
                            switch (currentHeatmapMode) {
                                case 'income':
                                    value = demoData.median_hh_income;
                                    break;
                                case 'homevalue':
                                    value = demoData.median_home_value;
                                    break;
                                case 'population':
                                    value = demoData.total_pop;
                                    break;
                                case 'kids500k':
                                    value = demoData.kids500k;
                                    break;
                            }
                            if (value > 0) values.push(value);
                        }
                    });
                }
            });
            
            if (values.length === 0) {
                currentPercentiles = {};
                return;
            }
            
            // Sort values
            values.sort((a, b) => a - b);
            
            // Calculate 5 percentile breakpoints (quintiles: 0%, 20%, 40%, 60%, 80%, 100%)
            currentPercentiles = {
                p0: values[0],
                p20: values[Math.floor(values.length * 0.2)],
                p40: values[Math.floor(values.length * 0.4)],
                p60: values[Math.floor(values.length * 0.6)],
                p80: values[Math.floor(values.length * 0.8)],
                p100: values[values.length - 1]
            };
            
            console.log(`Percentiles for ${currentHeatmapMode}:`, currentPercentiles);
        }
        
        // Update legend based on current heatmap mode
        function updateLegend() {
            const legendTitle = document.getElementById('legend-title');
            const legendItems = document.getElementById('legend-items');
            
            switch (currentHeatmapMode) {
                case 'enrollment':
                    legendTitle.textContent = 'Enrollment Score Legend';
                    legendItems.innerHTML = `
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff0000;"></span>
                            <span>5000+ (Excellent)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff8000;"></span>
                            <span>3000-4999 (Very Good)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ffff00;"></span>
                            <span>2500-2999 (Good)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #80ff00;"></span>
                            <span>1500-2499 (Fair)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #00ffff;"></span>
                            <span>500-1499 (Moderate)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: transparent; border: 1px solid #ccc;"></span>
                            <span>0-499 (Low - No Color)</span>
                        </div>
                    `;
                    break;
                    
                case 'kids500k':
                    legendTitle.textContent = 'Kids >$500k Legend (Fixed Breakpoints)';
                    legendItems.innerHTML = `
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff0000;"></span>
                            <span>1500+ (Excellent)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff8000;"></span>
                            <span>1000-1499 (Very Good)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ffff00;"></span>
                            <span>500-999 (Good)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #80ff00;"></span>
                            <span>250-499 (Fair)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #00ffff;"></span>
                            <span>100-249 (Moderate)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: transparent; border: 1px solid #ccc;"></span>
                            <span>&lt;100 (Low - No Color)</span>
                        </div>
                    `;
                    break;
                    
                case 'income':
                    const tuition = parseInt(document.getElementById('tuition-slider').value);
                    const incomeRed = (tuition * incomeMultiplier).toLocaleString();
                    const incomeOrange = (tuition * incomeMultiplier * 0.8).toLocaleString();
                    const incomeYellow = (tuition * incomeMultiplier * 0.6).toLocaleString();
                    const incomeGreen = (tuition * incomeMultiplier * 0.5).toLocaleString();
                    const incomeBlue = (tuition * incomeMultiplier * 0.4).toLocaleString();
                    
                    legendTitle.textContent = `Income Legend (${incomeMultiplier}x Multiplier, $${tuition.toLocaleString()} Tuition)`;
                    legendItems.innerHTML = `
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff0000;"></span>
                            <span>$${incomeRed}+ (Excellent - ${incomeMultiplier}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff8000;"></span>
                            <span>$${incomeOrange}-${(tuition * incomeMultiplier - 1).toLocaleString()} (Very Good - ${(incomeMultiplier * 0.8).toFixed(1)}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ffff00;"></span>
                            <span>$${incomeYellow}-${(tuition * incomeMultiplier * 0.8 - 1).toLocaleString()} (Good - ${(incomeMultiplier * 0.6).toFixed(1)}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #80ff00;"></span>
                            <span>$${incomeGreen}-${(tuition * incomeMultiplier * 0.6 - 1).toLocaleString()} (Fair - ${(incomeMultiplier * 0.5).toFixed(1)}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #00ffff;"></span>
                            <span>$${incomeBlue}-${(tuition * incomeMultiplier * 0.5 - 1).toLocaleString()} (Moderate - ${(incomeMultiplier * 0.4).toFixed(1)}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: transparent; border: 1px solid #ccc;"></span>
                            <span>&lt;$${incomeBlue} (Low)</span>
                        </div>
                    `;
                    break;
                    
                case 'homevalue':
                    const homeTuition = parseInt(document.getElementById('tuition-slider').value);
                    const homeRed = (homeTuition * homeValueMultiplier).toLocaleString();
                    const homeOrange = (homeTuition * homeValueMultiplier * 0.83).toLocaleString();
                    const homeYellow = (homeTuition * homeValueMultiplier * 0.625).toLocaleString();
                    const homeGreen = (homeTuition * homeValueMultiplier * 0.5).toLocaleString();
                    const homeBlue = (homeTuition * homeValueMultiplier * 0.42).toLocaleString();
                    
                    legendTitle.textContent = `Home Value Legend (${homeValueMultiplier}x Multiplier, $${homeTuition.toLocaleString()} Tuition)`;
                    legendItems.innerHTML = `
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff0000;"></span>
                            <span>$${homeRed}+ (Excellent - ${homeValueMultiplier}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff8000;"></span>
                            <span>$${homeOrange}-${(homeTuition * homeValueMultiplier - 1).toLocaleString()} (Very Good - ${(homeValueMultiplier * 0.83).toFixed(1)}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ffff00;"></span>
                            <span>$${homeYellow}-${(homeTuition * homeValueMultiplier * 0.83 - 1).toLocaleString()} (Good - ${(homeValueMultiplier * 0.625).toFixed(1)}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #80ff00;"></span>
                            <span>$${homeGreen}-${(homeTuition * homeValueMultiplier * 0.625 - 1).toLocaleString()} (Fair - ${(homeValueMultiplier * 0.5).toFixed(1)}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #00ffff;"></span>
                            <span>$${homeBlue}-${(homeTuition * homeValueMultiplier * 0.5 - 1).toLocaleString()} (Moderate - ${(homeValueMultiplier * 0.42).toFixed(1)}x)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: transparent; border: 1px solid #ccc;"></span>
                            <span>&lt;$${homeBlue} (Low)</span>
                        </div>
                    `;
                    break;
                    
                case 'composite':
                    legendTitle.textContent = 'Composite Score Legend (4 Metrics)';
                    legendItems.innerHTML = `
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff0000;"></span>
                            <span>Score 4 (Excellent - 18-20 pts)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff8000;"></span>
                            <span>Score 3 (Very Good - 14-17 pts)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ffff00;"></span>
                            <span>Score 2 (Good - 10-13 pts)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #80ff00;"></span>
                            <span>Score 1 (Fair - 6-9 pts)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: transparent; border: 1px solid #ccc;"></span>
                            <span>Score 0 (Low - 0-5 pts)</span>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 8px;">
                            Combines: Enrollment Score + Kids >$500k + Income + Home Value<br>
                            <em>Missing data treated as 0 points (no contribution)</em>
                        </div>
                    `;
                    break;
                    
                default:
                    // For other modes - use percentiles if needed
                    updatePercentileLegend();
                    break;
            }
        }
        
        // Update legend with percentile ranges
        function updatePercentileLegend() {
            const legendTitle = document.getElementById('legend-title');
            const legendItems = document.getElementById('legend-items');
            
            let title = '';
            let formatter = (val) => val.toLocaleString();
            
            switch (currentHeatmapMode) {
                case 'income':
                    title = 'Median Income Legend (Percentiles)';
                    formatter = (val) => '$' + val.toLocaleString();
                    break;
                case 'homevalue':
                    title = 'Median Home Value Legend (Percentiles)';
                    formatter = (val) => '$' + val.toLocaleString();
                    break;
                case 'population':
                    title = 'Population Legend (Percentiles)';
                    formatter = (val) => val.toLocaleString();
                    break;
            }
            
            legendTitle.textContent = title;
            
            if (!currentPercentiles.p0) {
                legendItems.innerHTML = '<div style="color: #666; font-style: italic;">Load states to see percentile ranges</div>';
                return;
            }
            
            legendItems.innerHTML = `
                <div class="legend-item">
                    <span class="legend-color" style="background: #ff0000;"></span>
                    <span>${formatter(currentPercentiles.p80)}+ (Top 20% - Excellent)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ff8000;"></span>
                    <span>${formatter(currentPercentiles.p60)} - ${formatter(currentPercentiles.p80)} (60-80% - Very Good)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ffff00;"></span>
                    <span>${formatter(currentPercentiles.p40)} - ${formatter(currentPercentiles.p60)} (40-60% - Good)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #80ff00;"></span>
                    <span>${formatter(currentPercentiles.p20)} - ${formatter(currentPercentiles.p40)} (20-40% - Fair)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #00ffff;"></span>
                    <span>${formatter(currentPercentiles.p0)} - ${formatter(currentPercentiles.p20)} (Bottom 20% - Moderate)</span>
                </div>
            `;
        }

        // Search for an address and place a pin
        async function searchAddress() {
            const addressInput = document.getElementById('address-search');
            const resultsDiv = document.getElementById('search-results');
            const address = addressInput.value.trim();
            
            if (!address) {
                resultsDiv.textContent = 'Please enter an address';
                return;
            }
            
            resultsDiv.textContent = 'Searching...';
            
            try {
                // Use Nominatim (OpenStreetMap) geocoding service
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=us&limit=1`);
                const data = await response.json();
                
                if (data.length === 0) {
                    resultsDiv.textContent = 'Address not found. Try a different format.';
                    return;
                }
                
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                
                // Clear previous search markers
                searchMarkers.forEach(marker => map.removeLayer(marker));
                searchMarkers = [];
                
                // Create a custom pin icon
                const pinIcon = L.divIcon({
                    className: 'search-pin',
                    html: `<div style="
                        background: #ff4444;
                        color: white;
                        border-radius: 50% 50% 50% 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        transform: rotate(-45deg);
                        border: 2px solid white;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    ">📍</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                });
                
                // Add marker to map
                const marker = L.marker([lat, lng], { icon: pinIcon }).addTo(map);
                searchMarkers.push(marker);
                
                // Pan to location
                map.setView([lat, lng], Math.max(map.getZoom(), 12));
                
                // Get state abbreviation from coordinates to load tract data
                const stateAbbr = getStateFromCoordinates(lat, lng);
                
                // Load state if not already loaded
                if (stateAbbr && !loadedStates.has(stateAbbr)) {
                    resultsDiv.textContent = `Found: ${result.display_name}. Loading ${stateAbbr} tract data...`;
                    await loadStateTracts(stateAbbr);
                }
                
                // Try to get tract information and scores
                setTimeout(() => {
                    const tractInfo = getTractInfoAtLocation(lat, lng);
                    if (tractInfo) {
                        const popupContent = createLocationPopup(result.display_name, tractInfo);
                        marker.bindPopup(popupContent).openPopup();
                        resultsDiv.innerHTML = `<span style="color: #28a745;">✓</span> Found: ${result.display_name}`;
                    } else {
                        resultsDiv.innerHTML = `<span style="color: #28a745;">✓</span> Found: ${result.display_name}<br><small>Load ${stateAbbr || 'state'} data to see tract scores</small>`;
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Geocoding error:', error);
                resultsDiv.textContent = 'Search failed. Please try again.';
            }
        }
        
        // Get state abbreviation from coordinates (rough approximation)
        function getStateFromCoordinates(lat, lng) {
            // Find the closest state center
            let closestState = null;
            let minDistance = Infinity;
            
            usStates.forEach(state => {
                const distance = Math.sqrt(Math.pow(lat - state.lat, 2) + Math.pow(lng - state.lng, 2));
                if (distance < minDistance) {
                    minDistance = distance;
                    closestState = state.abbr;
                }
            });
            
            return closestState;
        }
        
        // Get tract information at a specific location
        function getTractInfoAtLocation(lat, lng) {
            const point = L.latLng(lat, lng);
            
            // Check all loaded tract layers
            for (const [state, layer] of geojsonLayers) {
                let foundTract = null;
                layer.eachLayer(function(tractLayer) {
                    if (tractLayer.getBounds && tractLayer.getBounds().contains(point)) {
                        // More precise check using the actual geometry
                        if (isPointInPolygon(point, tractLayer)) {
                            foundTract = tractLayer.feature;
                            return false; // Break out of loop
                        }
                    }
                });
                if (foundTract) return foundTract;
            }
            return null;
        }
        
        // Simple point-in-polygon check
        function isPointInPolygon(point, layer) {
            try {
                const coords = layer.feature.geometry.coordinates;
                if (layer.feature.geometry.type === 'Polygon') {
                    return isPointInPolygonCoords(point, coords[0]);
                } else if (layer.feature.geometry.type === 'MultiPolygon') {
                    return coords.some(polygon => isPointInPolygonCoords(point, polygon[0]));
                }
            } catch (e) {
                // Fallback to bounds check
                return layer.getBounds().contains(point);
            }
            return false;
        }
        
        // Point in polygon algorithm
        function isPointInPolygonCoords(point, coords) {
            const x = point.lng, y = point.lat;
            let inside = false;
            
            for (let i = 0, j = coords.length - 1; i < coords.length; j = i++) {
                const xi = coords[i][0], yi = coords[i][1];
                const xj = coords[j][0], yj = coords[j][1];
                
                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            
            return inside;
        }
        
        // Create popup content for searched location
        function createLocationPopup(address, tractFeature) {
            const geoid = tractFeature.properties.GEOID;
            const tuition = parseInt(document.getElementById('tuition-slider').value);
            
            // Calculate all scores
            const enrollmentScore = calculateTractScore(tractFeature, tuition);
            const demoData = demographicData.get(geoid);
            const income = demoData ? demoData.median_hh_income : 0;
            const homeValue = demoData ? demoData.median_home_value : 0;
            // Get Kids >$500k with spatial fallback
            let kids500k = kids500kData.get(geoid);
            if (!kids500k || kids500k === 0) {
                kids500k = getKids500kBySpatial(tractFeature);
            }
            kids500k = kids500k || 0;
            const compositeScore = calculateCompositeScore(tractFeature);
            
            // Get colors
            const enrollmentColor = getEnrollmentColor(enrollmentScore);
            const kids500kColor = getKids500kColor(kids500k);
            const incomeColor = getIncomeColor(income);
            const homeValueColor = getHomeValueColor(homeValue);
            const compositeColor = getCompositeColor(compositeScore);
            
            return `
                <div style="min-width: 250px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">📍 Search Result</h4>
                    <div style="font-size: 12px; margin-bottom: 10px; color: #666;">${address}</div>
                    <div style="font-size: 11px; margin-bottom: 8px; color: #888;">Census Tract: ${geoid}</div>
                    
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 3px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: ${compositeColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            <strong>Composite Score: ${compositeScore}</strong>
                        </div>
                    </div>
                    
                    <div style="font-size: 11px; border-top: 1px solid #eee; padding-top: 6px;">
                        <div style="display: flex; align-items: center; margin-bottom: 2px;">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${enrollmentColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            Enrollment: ${enrollmentScore.toLocaleString()}
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 2px;">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${kids500kColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            Kids >$500k: ${kids500k.toLocaleString()}
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 2px;">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${incomeColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            Income: $${income.toLocaleString()}
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${homeValueColor}; border: 1px solid #ccc; margin-right: 6px;"></span>
                            Home Value: $${homeValue.toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Allow Enter key to trigger search
        document.addEventListener('DOMContentLoaded', function() {
            const addressInput = document.getElementById('address-search');
            if (addressInput) {
                addressInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchAddress();
                    }
                });
            }
        });

        // Start the application
        init();
    </script>
</body>
</html>
